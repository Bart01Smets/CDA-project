---
title: "Theoretical Exercise Analysis of Continuous Data"
author: "Thomas Sertijn, Bart Smets, Ilja Van Bever, Lieselot Van de Putte"
date: "2025-11-26"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,       # code verbergen
  message = FALSE,    # geen messages
  warning = FALSE     # geen warnings
)
```

```{r settings}
options(width = 100) 
```

# Continuous data Homework
# Thomas Sertijn, Bart Smets, Ilja Van Bever, Lieselot Van De Putte

This theoretical exercise is based on the article on A Material Paradox: Socioeconomic Status,
Young People’s Disposable Income and Consumer Culture by West et al. (2006). Everything
is to be derived from its table 1, that is also presented in Figure 1. It provides information on
income of teenagers in West Scotland. Based on the provided summary data, we will estimate
regression coefficients for a multivariable regression model.

We expect you to write out and justify calculations, whether in matrix- or simple
form, but the calculations themselves can be done in R - restricted to (matrix-)
multiplication, addition,…

0. One piece of information missing, is the number of correspondents (by age and gender).
Table 5 (not provided here) does provide some info on total sample size. We will assume
we work with 2142 correspondents, equally divided over the six groups (combination of
                                                                       age and gender)
• From table 1, does assume an equal number of girls and boys within each age-group,
seem reasonable?

Total almost always looks like the average of girl and boy so yes? 

  1. We could consider evaluating age as a continuous variable.
• Looking at Figure 1, would such a model provide a good fit? Explain

The effect looks non-linear, as the increase in total income between age 13 and 15 is a lot bigger than between 11 and 13. So it is probably better to keep it categorical. Difficult to say with only 3 datapoints though.

2. Depending on your answer in 1. fit either a model with age and gender as categorical, but
without interaction OR the same model without interaction but with age as a continuous
predictor
• Write out the model
• Estimate the coefficients
• Estimate the residual variance

We will model the income of an individual $i$ of group $j$ by the following formula.
$$Y_{ij} = \beta_0 + \beta_1 \cdot \text{Age13}_{ij} + \beta_2 \cdot \text{Age15}_{ij} + \beta_3 \cdot \text{Female}_{ij} + \varepsilon_{ij}$$
Design matrix X:
```{r matrices 2}
# Solution with matrices
# Data input
ntot <- 2142
n <- ntot/6 #(357)

age <- c(11, 11, 13, 13, 15, 15)
gender <- c("Male", "Female", "Male", "Female", "Male", "Female")
mean_vector <- c(4.56, 4.38, 8.78, 8.30, 15.94, 15.13)
sds_vector <- c(4.10, 4.16, 6.97, 6.57, 16.21, 12.90)

x1 <- c(1, 0, 0, 0) # 11yo, male
x2 <- c(1, 0, 0, 1) # 11yo, female
x3 <- c(1, 1, 0, 0) # 13yo, male
x4 <- c(1, 1, 0, 1) # 13yo, female
x5 <- c(1, 0, 1, 0) # 15yo, male
x6 <- c(1, 0, 1, 1) # 15yo, female

X <- rbind(x1, x2, x3, x4, x5, x6)
beta <- solve(t(X) %*% X) %*% t(X) %*% mean_vector
HAT <- X %*% solve(t(X) %*% X) %*% t(X)
SSE_mod <- t(mean_vector) %*% (diag(6) - HAT) %*% mean_vector
SSE <- sum((n-1)*(sds_vector^2)) + SSE_mod*n
MSE <- SSE/(ntot-4)
X
```
So we assume six groups with $n_j$ (`r n`) members.

- $x1$ is the group with 11 year old males;
- $x2$ is the group with 11 year old females;
- $x3$ is the group with 13 year old males;
- $x4$ is the group with 13 year old females;
- $x5$ is the group with 15 year old males;
- $x6$ is the group with 15 year old females.

$\beta$ can be estimated using the following equation:
$$\hat{\beta} = (X'X)^{-1}X'Y$$
After computation, the following vector is obtained for $\hat{\beta}$:
```{r beta1}
rownames(beta) <- c("Intercept", "Age13", "Age15", "Female")
colnames(beta) <- "beta estimated"
print(beta)
```
These are the estimated slope coefficients.

To estimate the residual variance, the SSE (sum of squared errors of the residuals) will be calculated. The SSE is not restricted to the SSE due to the modelling of the means of the groups (since the model without interaction terms will not give exact predictions of the group means). Also inside the groups there is a natural deviation from the mean. The SSE can be calculated as the sum of

- $n_j \cdot SSE_{model}$: the sum of squared residuals that is due to the fact that a linear model with 4 parameters is fitted to 6 data points. $SS_{model}$ is multiplicated with $n_j$ (the number of observations in each group), because $SSE_{model}$ is the sum for only six datapoints;
- $SSE_{groups}$: the sum of squared residuals that is due to the fact that there is a variance in the groups.

$$SSE_{total} = n_j \cdot SSE_{model} + SSE_{groups} = n_j \cdot \sum_{j=1}^{6} (\hat{y_{j}}-y_{j})^2 + \sum_{j=1}^{6}\sum_{i=1}^{n_j} (y_{ij}-y_{j})^2$$
with $\hat{y_j}$ the estimated average income of individuals of group $j$, $y_{j}$ the observed average income of individuals of group $j$ and $y_{ij}$ the observed income of an individual of group $j$.

To estimate $SSE_{model}$ the following equations are used.
$$H = X(X'X)^{-1}X'$$
$$SSE_{model} = Y'(I-H)Y$$
After calculation for $SSE_{model}$ a value of `r SSE_mod` can be obtained.

To calculate $SSE_{groups}$ for each group the formula $j$ $\sum_{i=1}^{n_j} (y_{ij}-\bar{y_{j}})^2$ is calculated based on the given standard deviations. We consider that these standard deviations are calculated from the data itself, so consider $n_j - 1$ degrees of freedom.

$$s_j^2 = \frac{1}{n_j - 1} \sum_{i=1}^{n_j} (y_{ij} - y_j)^2 \quad\text{so}\quad \sum_{i=1}^{n_j} (y_{ij} - y_j)^2 = (n_j - 1) \cdot s_j^2$$
So $SSE_{groups}$ can be calculated as follows.
$$SSE_{groups} = \sum_{j=1}^{6}\sum_{i=1}^{n_j} (y_{ij}-y_{j})^2 = \sum_{j=1}^{6}\left[(n_j - 1) \cdot s_j^2 \right]$$
And $MSE$ as follows.
$$MSE = \frac{SSE_{total}}{n_{tot}-p} = \frac{n_j \cdot SSE_{model} + SSE_{groups}}{n_{tot}-p}$$
with:

- $SSE_{model} =$ `r SSE_mod`;
- $SSE_{groups} =$ `r sum((n-1)*(sds_vector^2))`;
- $n_{tot} =$ `r ntot`;
- $p = 4$.

After calculation we derive that MSE is equal to `r MSE`.

• Interpret the gender-effect parameter(s)

The expected value of the income of a female is `r -beta[4]` pounds less that of a male, assumed that they are in the same age group (11 years, 13 years or 15 years).

• What would change above if sample consisted of brother-sister pairs?

The assumption of independence would be violated as observations are correlated (brothers and sisters come from the same family).

• (Continue as if all outcomes are independent)


3. Fit a standard linear model with both age and gender as categorical variables. Include
their interaction.
• Write out the model
• Estimate the coefficients
• Estimate the residual variance
• Interpret the gender-effect parameter(s)

We will model the income of an individual $i$ of group $j$ by the following formula.
$$Y_{ij} = \beta_0 + \beta_1 \cdot \text{Age13}_{ij} + \beta_2 \cdot \text{Age15}_{ij} + \beta_3 \cdot \text{Female}_{ij} + \beta_4 \cdot \text{Age13}_{ij} \cdot \text{Female}_{ij} + \beta_5 \cdot \text{Age15}_{ij} \cdot \text{Female}_{ij}+ \varepsilon_{ij}$$
```{r matrices 3}
# Solution with matrices

# Data input
ntot <- 2142
n <- ntot/6 #(357)
nr_of_betas <- 6

age <- c(11, 11, 13, 13, 15, 15)
gender <- c("Male", "Female", "Male", "Female", "Male", "Female")
mean_vector <- c(4.56, 4.38, 8.78, 8.30, 15.94, 15.13)
sds_vector <- c(4.10, 4.16, 6.97, 6.57, 16.21, 12.90)

x1 <- c(1, 0, 0, 0, 0, 0) # 11yo, male
x2 <- c(1, 0, 0, 1, 0, 0) # 11yo, female
x3 <- c(1, 1, 0, 0, 0, 0) # 13yo, male
x4 <- c(1, 1, 0, 1, 1, 0) # 13yo, female
x5 <- c(1, 0, 1, 0, 0, 0) # 15yo, male
x6 <- c(1, 0, 1, 1, 0, 1) # 15yo, female

X <- rbind(x1, x2, x3, x4, x5, x6)
beta <- solve(t(X) %*% X) %*% t(X) %*% mean_vector

HAT <- X %*% solve(t(X) %*% X) %*% t(X)
SSE_mod <- t(mean_vector) %*% (diag(6) - HAT) %*% mean_vector
SSE <- sum((n-1)*(sds_vector^2)) + SSE_mod*n
MSE <- SSE/(ntot-6)
```

To solve this exercise the following $X$-matrix can be used:
```{r}
X
```
So the $X$-matrix has two extra columns, because of the two extra parameters.

$\beta$ can again be estimated using the following equation:
$$\hat{\beta} = (X'X)^{-1}X'Y$$
After computation, the following vector is obtained for $\hat{\beta}$:
```{r beta2}
rownames(beta) <- c("Intercept", "Age13", "Age15", "Female", "Age13*Female", "Age15*Female")
colnames(beta) <- "beta estimated"
print(beta)
```

The MSE can be calculated using the same formulas as mentioned in exercise 2.
$$MSE = \frac{SSE_{total}}{n_{tot}-p} = \frac{n_j \cdot SSE_{model} + SSE_{groups}}{n_{tot}-p}$$
with:

- $SSE_{model} =$ `r SSE_mod`;
- $SSE_{groups} =$ `r sum((n-1)*(sds_vector^2))`;
- $n_{tot} =$ `r ntot`;
- $p = 6$.

After calculation we derive that MSE is equal to `r MSE`. So the MSE is larger now than the MSE in exercise 2, because the denominator in the formulae to calculate is now smaller (more parameters in the model).

It can be observed that $SSE_{model}$ is negligible. Actually $SSE_{model}$ is equal to zero, because a model with six parameters is fitted to 6 datapoints. So the group the estimates for the averages of the groups will be exactly equal to the observed averages.

$$Y_{ij} = \beta_0 + \beta_1 \cdot \text{Age13}_{ij} + \beta_2 \cdot \text{Age15}_{ij} + \beta_3 \cdot \text{Female}_{ij} + \beta_4 \cdot \text{Age13}_{ij} \cdot \text{Female}_{ij} + \beta_5 \cdot \text{Age15}_{ij} \cdot \text{Female}_{ij}+ \varepsilon_{ij}$$
The gender-effect parameters can be interpreted as follows.

- $\beta_3 =$ `r beta[4]`: a female of 11 years old is expected to have an income of `r -beta[4]` (-$\beta_3$) pound less than a male of 11 years old;
- $\beta_4 =$ `r beta[5]`: `r beta[4]` ($\beta_3$) + `r beta[5]` ($\beta_4$) $=$ `r beta[4]+beta[5]`, so a female of 13 years old is expected to have an income of `r -beta[4]-beta[5]` pound less than a male of 13 years old;
- $\beta_5 =$ `r beta[6]`: `r beta[4]` ($\beta_3$) + `r beta[6]` ($\beta_5$) $=$ `r beta[4]+beta[6]`, so a female of 15 years old is expected to have an income of `r -beta[4]-beta[6]` pound less than a male of 15 years old;

4. Compare both models in terms of:
• Underlying assumptions
• Formally test if the model with interaction (3.) fits the data better

5. From the model with interaction (3.), derive a 95% prediction interval for the income of
a 15 year old girl. Is this prediction interval likely to have the nominal 95% coverage?
Why? If not, will the coverage tend to be higher or lower?